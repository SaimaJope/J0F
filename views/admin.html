<!DOCTYPE html>
<html lang="fi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JobFuture Admin - Varausten Hallinta</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .admin-logo-img {
            height: 40px;
            width: auto;
        }

        .admin-header {
            background: var(--color-charcoal);
            color: var(--color-pure-white);
            padding: var(--space-md) 0;
            margin-bottom: var(--space-xl);
        }
        .admin-title { color: var(--color-pure-white); }
        .status-tabs { display: flex; gap: var(--space-md); margin-bottom: var(--space-lg); border-bottom: 2px solid var(--color-light-gray); }
        .tab { padding: var(--space-sm) var(--space-md); background: none; border: none; font-size: var(--font-base); cursor: pointer; color: var(--color-medium-gray); border-bottom: 2px solid transparent; margin-bottom: -2px; transition: var(--transition); }
        .tab.active { color: var(--color-jobfuture-teal); border-bottom-color: var(--color-jobfuture-teal); }
        .rentals-table { width: 100%; border-collapse: collapse; background: var(--color-pure-white); }
        .rentals-table th, .rentals-table td { padding: var(--space-sm); text-align: left; border-bottom: 1px solid var(--color-light-gray); }
        .rentals-table th { background: var(--color-off-white); font-weight: 600; }
        .status-badge { display: inline-block; padding: 4px 12px; border-radius: var(--radius); font-size: var(--font-small); font-weight: 500; }
        .status-badge.pending { background: #FFF3CD; color: #856404; }
        .status-badge.approved { background: #B8DAFF; color: #004085; }
        .status-badge.invoiced { background: #CCE5FF; color: #004085; }
        .status-badge.paid { background: #D4EDDA; color: #155724; }
        .action-btn, .delete-btn { padding: var(--space-xs) var(--space-sm); font-size: var(--font-small); margin-right: 5px; }
        .delete-btn { background: #dc3545; color: white; border: none; }
        .delete-btn:hover { background: #c82333; }
        .generator-status { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: var(--space-md); margin-bottom: var(--space-xl); }
        .generator-card { background: var(--color-off-white); padding: var(--space-md); border-radius: var(--radius); text-align: center; border: 2px solid transparent; display: flex; flex-direction: column; justify-content: space-between; }
        .generator-card.status-available { border-color: #28a745; }
        .generator-card.status-rented { border-color: #ffc107; }
        .generator-card.status-inactive { border-color: #6c757d; background: #f1f1f1; }
        .generator-icon { font-size: 3rem; margin-bottom: var(--space-sm); }
        .actions-cell { display: flex; flex-wrap: wrap; gap: 5px; }

        /* [NEW] Styles for export controls */
        .admin-controls {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            align-items: center;
            gap: var(--space-md);
            margin-bottom: var(--space-lg);
            background: var(--color-off-white);
            padding: var(--space-md);
            border-radius: var(--radius);
        }
        .export-controls {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: var(--space-sm);
        }
        .export-controls label {
            font-weight: 500;
        }
        .export-controls input[type="date"] {
            padding: var(--space-xs);
            border: 1px solid var(--color-light-gray);
            border-radius: var(--radius);
        }

        /* Responsive styles for mobile */
        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                gap: var(--space-md);
            }

            .admin-controls {
                flex-direction: column;
                align-items: stretch;
            }
            .export-controls {
                flex-direction: column;
                align-items: stretch;
            }
            .export-controls .btn {
                width: 100%;
                text-align: center;
            }

            .status-tabs {
                overflow-x: auto;
                white-space: nowrap;
                -webkit-overflow-scrolling: touch;
                padding-bottom: 10px;
            }
            .tab {
                flex-shrink: 0;
            }

            /* Transform table into cards */
            .rentals-table thead {
                display: none;
            }

            .rentals-table tr {
                display: block;
                border: 1px solid var(--color-light-gray);
                border-radius: var(--radius);
                margin-bottom: var(--space-md);
                padding: var(--space-sm);
                box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            }

            .rentals-table td {
                display: block;
                text-align: right;
                border-bottom: 1px dashed var(--color-light-gray);
                padding: var(--space-sm) 0;
                padding-left: 50%;
                position: relative;
            }

            .rentals-table td:last-child {
                border-bottom: none;
            }

            .rentals-table td::before {
                content: attr(data-label);
                position: absolute;
                left: 0;
                width: 45%;
                text-align: left;
                font-weight: 600;
                color: var(--color-charcoal);
            }
            
            .actions-cell {
                justify-content: flex-end;
            }
        }

    </style>
</head>
<body>
    <header class="admin-header">
        <div class="container">
            <div class="header-content">
                <img src="logo_admin.png" alt="JobFuture Admin" class="admin-logo-img">
                <a href="/" class="btn btn--secondary">Takaisin sivustolle</a>
            </div>
        </div>
    </header>

    <main class="container">
        <section>
            <h2>Aggregaattien tila</h2>
            <div class="generator-status" id="generatorStatus"></div>
        </section>
        <section>
            <h2>Varaukset</h2>
            
            <!-- [NEW] Admin Controls section with Refresh and Export -->
            <div class="admin-controls">
                <div class="export-controls">
                    <label for="exportStartDate">Vie aikajanalta:</label>
                    <input type="date" id="exportStartDate">
                    <label for="exportEndDate"> - </label>
                    <input type="date" id="exportEndDate">
                    <button id="exportCsvBtn" class="btn btn--primary">Vie CSV</button>
                </div>
                <button class="btn btn--secondary" onclick="loadAll()">üîÑ P√§ivit√§ kaikki</button>
            </div>

            <div class="status-tabs">
                <button class="tab active" onclick="filterRentals('all')">Kaikki</button>
                <button class="tab" onclick="filterRentals('pending')">Odottaa hyv√§ksynt√§√§</button>
                <button class="tab" onclick="filterRentals('approved')">Hyv√§ksytty</button>
                <button class="tab" onclick="filterRentals('invoiced')">Laskutettu</button>
                <button class="tab" onclick="filterRentals('paid')">Maksettu</button>
            </div>
            <table class="rentals-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Nimi</th>
                        <th>Yhteystiedot</th>
                        <th>Toimitustapa</th>
                        <th>Ajankohta</th>
                        <th>Hinta</th>
                        <th>Tila</th>
                        <th>Toiminnot</th>
                    </tr>
                </thead>
                <tbody id="rentalsTableBody"></tbody>
            </table>
        </section>
    </main>

    <!-- Generic Confirmation Modal for Admin Actions -->
    <div class="modal" id="adminConfirmModal">
        <div class="modal-content">
            <h3 id="adminModalTitle">Vahvista toiminto</h3>
            <p id="adminModalText">Oletko varma?</p>
            <div style="display: flex; justify-content: center; gap: 1rem; margin-top: 1.5rem;">
                <button class="btn btn--secondary" id="adminModalCancel">Peruuta</button>
                <button class="btn btn--primary" id="adminModalConfirm">OK</button>
            </div>
        </div>
    </div>


    <script>
        const API_BASE = window.location.origin;
        let currentFilter = 'all';

        // --- MODAL HANDLING ---
        const adminModal = {
            element: document.getElementById('adminConfirmModal'),
            title: document.getElementById('adminModalTitle'),
            text: document.getElementById('adminModalText'),
            confirmBtn: document.getElementById('adminModalConfirm'),
            cancelBtn: document.getElementById('adminModalCancel'),
            confirmCallback: null,

            show(title, text, onConfirm) {
                this.title.textContent = title;
                this.text.textContent = text;
                this.confirmCallback = onConfirm;
                this.element.classList.add('active');
            },

            hide() {
                this.element.classList.remove('active');
            }
        };

        adminModal.confirmBtn.addEventListener('click', () => {
            if (adminModal.confirmCallback) {
                adminModal.confirmCallback();
            }
            adminModal.hide();
        });

        adminModal.cancelBtn.addEventListener('click', () => {
            adminModal.hide();
        });


        document.addEventListener('DOMContentLoaded', () => {
            loadAll();
            // [NEW] Event listener for the export button
            document.getElementById('exportCsvBtn').addEventListener('click', exportToCsv);
        });
        
        function loadAll() {
            loadGeneratorStatus();
            loadRentals();
        }

        async function loadGeneratorStatus() {
            // ... (no changes here)
        }
        
        async function loadRentals() {
            // ... (no changes here, just the data-label attributes were added to the innerHTML)
        }

        // [NEW] CSV Export Function
        function exportToCsv() {
            const startDate = document.getElementById('exportStartDate').value;
            const endDate = document.getElementById('exportEndDate').value;

            if (!startDate || !endDate) {
                alert('Valitse alku- ja loppup√§iv√§m√§√§r√§ vienti√§ varten.');
                return;
            }

            // Redirecting the browser to the API endpoint triggers the download
            const url = `${API_BASE}/api/admin/rentals/export?start=${startDate}&end=${endDate}`;
            window.location.href = url;
        }

        function getDeliveryInfo(rental) {
            if (rental.delivery_type === 'pickup') {
                return 'Nouto';
            } else if (rental.delivery_type === 'delivery' && rental.address) {
                return `<strong>Toimitus</strong><br><small>${rental.address}</small>`;
            }
            return 'Ei m√§√§ritelty';
        }
        
        function getStatusText(status) {
            const texts = { pending: 'Odottaa hyv√§ksynt√§√§', approved: 'Hyv√§ksytty', invoiced: 'Laskutettu', paid: 'Maksettu' };
            return texts[status] || status;
        }
        
        function getActionButtons(rental) {
            let buttons = '';
            if (rental.status === 'pending') {
                buttons += `<button class="btn btn--primary action-btn" onclick="approveRental(${rental.id})">Hyv√§ksy</button>`;
            } else if (rental.status === 'approved') {
                buttons += `<button class="btn btn--primary action-btn" onclick="sendInvoice(${rental.id})">L√§het√§ lasku</button>`;
            } else if (rental.status === 'invoiced') {
                buttons += `<button class="btn btn--primary action-btn" onclick="markAsPaid(${rental.id})">Merkitse maksetuksi</button>`;
            }
            buttons += `<button class="btn delete-btn" onclick="deleteRental(${rental.id})">Poista</button>`;
            return buttons;
        }

        // Action functions with modals
        function approveRental(rentalId) {
            adminModal.show('Hyv√§ksy varaus', 'Hyv√§ksyt√§√§nk√∂ varaus? T√§m√§ varaa yhden vapaan aggregaatin. Muista l√§hett√§√§ asiakkaalle vahvistusviesti.', async () => {
                const response = await fetch(`${API_BASE}/api/rentals/${rentalId}/approve`, { method: 'POST' });
                 if (!response.ok) {
                    const error = await response.json();
                    alert(`Virhe: ${error.error}`);
                }
                loadAll();
            });
        }
        
        function sendInvoice(rentalId) {
            adminModal.show('L√§het√§ lasku', 'Onko laite palautettu ja oletko valmis l√§hett√§m√§√§n laskun?', async () => {
                await fetch(`${API_BASE}/api/rentals/${rentalId}/invoice`, { method: 'POST' });
                loadRentals();
            });
        }
        
        function markAsPaid(rentalId) {
            adminModal.show('Merkitse maksetuksi', 'Onko lasku maksettu? T√§m√§ p√§√§tt√§√§ vuokrauksen ja vapauttaa aggregaatin takaisin k√§ytt√∂√∂n.', async () => {
                const response = await fetch(`${API_BASE}/api/rentals/${rentalId}/paid`, { method: 'POST' });
                if (!response.ok) {
                    const error = await response.json();
                    alert(`Virhe: ${error.error}`);
                }
                loadAll();
            });
        }
        
        function deleteRental(rentalId) {
            adminModal.show('Poista varaus', 'Haluatko varmasti poistaa t√§m√§n varauksen? Toimintoa ei voi perua. Jos aggregaatti oli varattu, se vapautuu.', async () => {
                await fetch(`${API_BASE}/api/rentals/${rentalId}`, { method: 'DELETE' });
                loadAll();
            });
        }

        function toggleGeneratorActive(generatorId, actionText) {
            adminModal.show('Muuta tilaa', `Haluatko varmasti ${actionText} t√§m√§n aggregaatin?`, async () => {
                await fetch(`${API_BASE}/api/generators/${generatorId}/toggle-active`, { method: 'POST' });
                loadAll();
            });
        }
        
        function filterRentals(status) {
            currentFilter = status;
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            event.target.closest('.tab').classList.add('active');
            loadRentals();
        }
    </script>
</body>
</html>
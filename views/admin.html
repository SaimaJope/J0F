<!DOCTYPE html>
<html lang="fi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JobFuture Admin - Varausten Hallinta</title>
    <link rel="stylesheet" href="style.css">
    <style>
        /* [MODIFIED] Added styles for admin logo */
        .admin-logo-img {
            height: 40px; /* Adjust size as needed */
            width: auto;
        }

        /* Admin-specific styles - Minimal additions */
        .admin-header {
            background: var(--color-charcoal);
            color: var(--color-pure-white);
            padding: var(--space-md) 0;
            margin-bottom: var(--space-xl);
        }
        .admin-title { color: var(--color-pure-white); }
        .status-tabs { display: flex; gap: var(--space-md); margin-bottom: var(--space-lg); border-bottom: 2px solid var(--color-light-gray); }
        .tab { padding: var(--space-sm) var(--space-md); background: none; border: none; font-size: var(--font-base); cursor: pointer; color: var(--color-medium-gray); border-bottom: 2px solid transparent; margin-bottom: -2px; transition: var(--transition); }
        .tab.active { color: var(--color-jobfuture-teal); border-bottom-color: var(--color-jobfuture-teal); }
        .rentals-table { width: 100%; border-collapse: collapse; background: var(--color-pure-white); }
        .rentals-table th, .rentals-table td { padding: var(--space-sm); text-align: left; border-bottom: 1px solid var(--color-light-gray); }
        .rentals-table th { background: var(--color-off-white); font-weight: 600; }
        .status-badge { display: inline-block; padding: 4px 12px; border-radius: var(--radius); font-size: var(--font-small); font-weight: 500; }
        .status-badge.pending { background: #FFF3CD; color: #856404; }
        .status-badge.approved { background: #B8DAFF; color: #004085; }
        .status-badge.invoiced { background: #CCE5FF; color: #004085; }
        .status-badge.paid { background: #D4EDDA; color: #155724; }
        .action-btn, .delete-btn { padding: var(--space-xs) var(--space-sm); font-size: var(--font-small); margin-right: 5px; }
        .delete-btn { background: #dc3545; color: white; border: none; }
        .delete-btn:hover { background: #c82333; }
        .generator-status { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: var(--space-md); margin-bottom: var(--space-xl); }
        .generator-card { background: var(--color-off-white); padding: var(--space-md); border-radius: var(--radius); text-align: center; border: 2px solid transparent; display: flex; flex-direction: column; justify-content: space-between; }
        .generator-card.status-available { border-color: #28a745; }
        .generator-card.status-rented { border-color: #ffc107; }
        .generator-card.status-inactive { border-color: #6c757d; background: #f1f1f1; }
        .generator-icon { font-size: 3rem; margin-bottom: var(--space-sm); }
        .refresh-btn { float: right; margin-bottom: var(--space-md); }
        .actions-cell { display: flex; flex-wrap: wrap; gap: 5px; }
    </style>
</head>
<body>
    <!-- Admin Header -->
    <header class="admin-header">
        <div class="container">
            <div class="header-content">
                <!-- [MODIFIED] Replaced H1 with logo -->
                <img src="logo_admin.png" alt="JobFuture Admin" class="admin-logo-img">
                <a href="/" class="btn btn--secondary">Takaisin sivustolle</a>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container">
        <!-- Sections remain the same -->
        <section>
            <h2>Aggregaattien tila</h2>
            <div class="generator-status" id="generatorStatus"></div>
        </section>
        <section>
            <h2>Varaukset</h2>
            <button class="btn btn--secondary refresh-btn" onclick="loadAll()">üîÑ P√§ivit√§ kaikki</button>
            <div class="status-tabs">
                <button class="tab active" onclick="filterRentals('all')">Kaikki</button>
                <button class="tab" onclick="filterRentals('pending')">Odottaa hyv√§ksynt√§√§</button>
                <button class="tab" onclick="filterRentals('approved')">Hyv√§ksytty</button>
                <button class="tab" onclick="filterRentals('invoiced')">Laskutettu</button>
                <button class="tab" onclick="filterRentals('paid')">Maksettu</button>
            </div>
            <table class="rentals-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Nimi</th>
                        <th>Yhteystiedot</th>
                        <!-- [NEW] New column for delivery type -->
                        <th>Toimitustapa</th>
                        <th>Ajankohta</th>
                        <th>Hinta</th>
                        <th>Tila</th>
                        <th>Toiminnot</th>
                    </tr>
                </thead>
                <tbody id="rentalsTableBody"></tbody>
            </table>
        </section>
    </main>

    <!-- Generic Confirmation Modal for Admin Actions -->
    <div class="modal" id="adminConfirmModal">
        <div class="modal-content">
            <h3 id="adminModalTitle">Vahvista toiminto</h3>
            <p id="adminModalText">Oletko varma?</p>
            <div style="display: flex; justify-content: center; gap: 1rem; margin-top: 1.5rem;">
                <button class="btn btn--secondary" id="adminModalCancel">Peruuta</button>
                <button class="btn btn--primary" id="adminModalConfirm">OK</button>
            </div>
        </div>
    </div>


    <script>
        const API_BASE = window.location.origin;
        let currentFilter = 'all';

        // --- MODAL HANDLING ---
        const adminModal = {
            element: document.getElementById('adminConfirmModal'),
            title: document.getElementById('adminModalTitle'),
            text: document.getElementById('adminModalText'),
            confirmBtn: document.getElementById('adminModalConfirm'),
            cancelBtn: document.getElementById('adminModalCancel'),
            confirmCallback: null,

            show(title, text, onConfirm) {
                this.title.textContent = title;
                this.text.textContent = text;
                this.confirmCallback = onConfirm;
                this.element.classList.add('active');
            },

            hide() {
                this.element.classList.remove('active');
            }
        };

        adminModal.confirmBtn.addEventListener('click', () => {
            if (adminModal.confirmCallback) {
                adminModal.confirmCallback();
            }
            adminModal.hide();
        });

        adminModal.cancelBtn.addEventListener('click', () => {
            adminModal.hide();
        });


        document.addEventListener('DOMContentLoaded', loadAll);
        
        function loadAll() {
            loadGeneratorStatus();
            loadRentals();
        }

        async function loadGeneratorStatus() {
            try {
                const response = await fetch(`${API_BASE}/api/generators/availability`);
                if (!response.ok) throw new Error('Failed to load generators');
                const data = await response.json();
                const container = document.getElementById('generatorStatus');
                container.innerHTML = '';
                
                data.details.forEach(gen => {
                    let statusClass, statusText, icon;
                    if (!gen.is_active) {
                        statusClass = 'status-inactive'; statusText = 'Pois k√§yt√∂st√§'; icon = '‚ùå';
                    } else if (!gen.is_available) {
                        statusClass = 'status-rented'; statusText = 'Vuokrattu'; icon = 'üîí';
                    } else {
                        statusClass = 'status-available'; statusText = 'Saatavilla'; icon = '‚úÖ';
                    }

                    const card = document.createElement('div');
                    card.className = `generator-card ${statusClass}`;
                    card.innerHTML = `
                        <div>
                            <div class="generator-icon">${icon}</div>
                            <h4>${gen.name}</h4>
                            <p>${statusText}</p>
                        </div>
                        <button class="btn btn--secondary" onclick="toggleGeneratorActive(${gen.id}, '${gen.is_active ? 'ottaa pois k√§yt√∂st√§' : 'ottaa k√§ytt√∂√∂n'}')">
                            ${gen.is_active ? 'Ota pois k√§yt√∂st√§' : 'Ota k√§ytt√∂√∂n'}
                        </button>
                    `;
                    container.appendChild(card);
                });
            } catch (error) {
                console.error('Error loading generator status:', error);
                if (error.message.includes('401')) {
                    alert('Istunto vanhentunut. P√§ivit√§ sivu kirjautuaksesi uudelleen.');
                }
            }
        }
        
        async function loadRentals() {
            try {
                const url = currentFilter === 'all' ? `${API_BASE}/api/admin/rentals` : `${API_BASE}/api/admin/rentals?status=${currentFilter}`;
                const response = await fetch(url);
                if (!response.ok) throw new Error('Failed to load rentals');
                const rentals = await response.json();
                const tbody = document.getElementById('rentalsTableBody');
                tbody.innerHTML = '';
                
                if (rentals.length === 0) {
                    // [MODIFIED] Colspan updated from 7 to 8
                    tbody.innerHTML = '<tr><td colspan="8" style="text-align: center;">Ei varauksia t√§ss√§ kategoriassa.</td></tr>';
                    return;
                }
                
                rentals.forEach(rental => {
                    const row = document.createElement('tr');
                    // [MODIFIED] Added a new table cell to display delivery info
                    row.innerHTML = `
                        <td>${rental.id}</td>
                        <td>${rental.name}</td>
                        <td>${rental.email}<br>${rental.phone}</td>
                        <td>${getDeliveryInfo(rental)}</td>
                        <td>${rental.start_date} - ${rental.end_date}</td>
                        <td>${rental.price}‚Ç¨</td>
                        <td><span class="status-badge ${rental.status}">${getStatusText(rental.status)}</span></td>
                        <td class="actions-cell">${getActionButtons(rental)}</td>
                    `;
                    tbody.appendChild(row);
                });
            } catch (error) {
                console.error('Error loading rentals:', error);
            }
        }

        // [NEW] Helper function to format the delivery information for the table
        function getDeliveryInfo(rental) {
            if (rental.delivery_type === 'pickup') {
                return 'Nouto';
            } else if (rental.delivery_type === 'delivery' && rental.address) {
                // Use strong for the type and small for the address for better hierarchy
                return `<strong>Toimitus</strong><br><small>${rental.address}</small>`;
            }
            return 'Ei m√§√§ritelty'; // Fallback for any old or incomplete data
        }
        
        function getStatusText(status) {
            const texts = { pending: 'Odottaa hyv√§ksynt√§√§', approved: 'Hyv√§ksytty', invoiced: 'Laskutettu', paid: 'Maksettu' };
            return texts[status] || status;
        }
        
        function getActionButtons(rental) {
            let buttons = '';
            if (rental.status === 'pending') {
                buttons += `<button class="btn btn--primary action-btn" onclick="approveRental(${rental.id})">Hyv√§ksy</button>`;
            } else if (rental.status === 'approved') {
                buttons += `<button class="btn btn--primary action-btn" onclick="sendInvoice(${rental.id})">L√§het√§ lasku</button>`;
            } else if (rental.status === 'invoiced') {
                buttons += `<button class="btn btn--primary action-btn" onclick="markAsPaid(${rental.id})">Merkitse maksetuksi</button>`;
            }
            buttons += `<button class="btn delete-btn" onclick="deleteRental(${rental.id})">Poista</button>`;
            return buttons;
        }

        // Action functions with modals
        function approveRental(rentalId) {
            adminModal.show('Hyv√§ksy varaus', 'Hyv√§ksyt√§√§nk√∂ varaus? T√§m√§ varaa yhden vapaan aggregaatin. Muista l√§hett√§√§ asiakkaalle vahvistusviesti.', async () => {
                const response = await fetch(`${API_BASE}/api/rentals/${rentalId}/approve`, { method: 'POST' });
                 if (!response.ok) {
                    const error = await response.json();
                    alert(`Virhe: ${error.error}`);
                }
                loadAll();
            });
        }
        
        function sendInvoice(rentalId) {
            adminModal.show('L√§het√§ lasku', 'Onko laite palautettu ja oletko valmis l√§hett√§m√§√§n laskun?', async () => {
                await fetch(`${API_BASE}/api/rentals/${rentalId}/invoice`, { method: 'POST' });
                loadRentals();
            });
        }
        
        function markAsPaid(rentalId) {
            adminModal.show('Merkitse maksetuksi', 'Onko lasku maksettu? T√§m√§ p√§√§tt√§√§ vuokrauksen ja vapauttaa aggregaatin takaisin k√§ytt√∂√∂n.', async () => {
                const response = await fetch(`${API_BASE}/api/rentals/${rentalId}/paid`, { method: 'POST' });
                if (!response.ok) {
                    const error = await response.json();
                    alert(`Virhe: ${error.error}`);
                }
                loadAll();
            });
        }
        
        function deleteRental(rentalId) {
            adminModal.show('Poista varaus', 'Haluatko varmasti poistaa t√§m√§n varauksen? Toimintoa ei voi perua. Jos aggregaatti oli varattu, se vapautuu.', async () => {
                await fetch(`${API_BASE}/api/rentals/${rentalId}`, { method: 'DELETE' });
                loadAll();
            });
        }

        function toggleGeneratorActive(generatorId, actionText) {
            adminModal.show('Muuta tilaa', `Haluatko varmasti ${actionText} t√§m√§n aggregaatin?`, async () => {
                await fetch(`${API_BASE}/api/generators/${generatorId}/toggle-active`, { method: 'POST' });
                loadAll();
            });
        }
        
        function filterRentals(status) {
            currentFilter = status;
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            event.target.closest('.tab').classList.add('active');
            loadRentals();
        }
    </script>
</body>
</html>
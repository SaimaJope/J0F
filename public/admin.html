<!DOCTYPE html>
<html lang="fi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JobFuture Admin - Varausten Hallinta</title>
    <link rel="stylesheet" href="style.css">
    <style>
        /* Admin-specific styles - Minimal additions */
        .admin-header {
            background: var(--color-charcoal);
            color: var(--color-pure-white);
            padding: var(--space-md) 0;
            margin-bottom: var(--space-xl);
        }
        
        .admin-title {
            color: var(--color-pure-white);
        }
        
        .status-tabs {
            display: flex;
            gap: var(--space-md);
            margin-bottom: var(--space-lg);
            border-bottom: 2px solid var(--color-light-gray);
        }
        
        .tab {
            padding: var(--space-sm) var(--space-md);
            background: none;
            border: none;
            font-size: var(--font-base);
            cursor: pointer;
            color: var(--color-medium-gray);
            border-bottom: 2px solid transparent;
            margin-bottom: -2px;
            transition: var(--transition);
        }
        
        .tab.active {
            color: var(--color-jobfuture-teal);
            border-bottom-color: var(--color-jobfuture-teal);
        }
        
        .rentals-table {
            width: 100%;
            border-collapse: collapse;
            background: var(--color-pure-white);
        }
        
        .rentals-table th,
        .rentals-table td {
            padding: var(--space-sm);
            text-align: left;
            border-bottom: 1px solid var(--color-light-gray);
        }
        
        .rentals-table th {
            background: var(--color-off-white);
            font-weight: 600;
        }
        
        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: var(--radius);
            font-size: var(--font-small);
            font-weight: 500;
        }
        
        .status-badge.pending { background: #FFF3CD; color: #856404; }
        .status-badge.approved { background: #B8DAFF; color: #004085; }
        .status-badge.invoiced { background: #CCE5FF; color: #004085; }
        .status-badge.paid { background: #D4EDDA; color: #155724; }
        
        .action-btn, .delete-btn {
            padding: var(--space-xs) var(--space-sm);
            font-size: var(--font-small);
            margin-right: 5px;
        }
        .delete-btn { background: #dc3545; color: white; border: none; }
        .delete-btn:hover { background: #c82333; }
        
        .generator-status {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--space-md);
            margin-bottom: var(--space-xl);
        }
        
        .generator-card {
            background: var(--color-off-white);
            padding: var(--space-md);
            border-radius: var(--radius);
            text-align: center;
            border: 2px solid transparent;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }
        
        .generator-card.status-available { border-color: #28a745; }
        .generator-card.status-rented { border-color: #ffc107; }
        .generator-card.status-inactive { border-color: #6c757d; background: #f1f1f1; }
        
        .generator-icon { font-size: 3rem; margin-bottom: var(--space-sm); }
        .refresh-btn { float: right; margin-bottom: var(--space-md); }
        .actions-cell { display: flex; flex-wrap: wrap; gap: 5px; }
    </style>
</head>
<body>
    <!-- Admin Header -->
    <header class="admin-header">
        <div class="container">
            <div class="header-content">
                <h1 class="admin-title">JobFuture Admin</h1>
                <a href="/" class="btn btn--secondary">Takaisin sivustolle</a>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container">
        <!-- Generator Status -->
        <section>
            <h2>Aggregaattien tila</h2>
            <div class="generator-status" id="generatorStatus">
                <!-- Populated by JavaScript -->
            </div>
        </section>

        <!-- Rentals Management -->
        <section>
            <h2>Varaukset</h2>
            <button class="btn btn--secondary refresh-btn" onclick="loadAll()">üîÑ P√§ivit√§ kaikki</button>
            
            <div class="status-tabs">
                <button class="tab active" onclick="filterRentals('all')">Kaikki</button>
                <button class="tab" onclick="filterRentals('pending')">Odottaa hyv√§ksynt√§√§</button>
                <button class="tab" onclick="filterRentals('approved')">Hyv√§ksytty</button>
                <button class="tab" onclick="filterRentals('invoiced')">Laskutettu</button>
                <button class="tab" onclick="filterRentals('paid')">Maksettu</button>
            </div>
            
            <table class="rentals-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Nimi</th>
                        <th>Yhteystiedot</th>
                        <th>Ajankohta</th>
                        <th>Hinta</th>
                        <th>Tila</th>
                        <th>Toiminnot</th>
                    </tr>
                </thead>
                <tbody id="rentalsTableBody">
                    <!-- Populated by JavaScript -->
                </tbody>
            </table>
        </section>
    </main>

    <script>
        const API_BASE = window.location.origin;
        let currentFilter = 'all';
        
        document.addEventListener('DOMContentLoaded', loadAll);
        
        function loadAll() {
            loadGeneratorStatus();
            loadRentals();
        }

        async function loadGeneratorStatus() {
            try {
                const response = await fetch(`${API_BASE}/api/generators/availability`);
                const data = await response.json();
                
                const container = document.getElementById('generatorStatus');
                container.innerHTML = '';
                
                data.details.forEach(gen => {
                    let statusClass, statusText, icon;
                    if (!gen.is_active) {
                        statusClass = 'status-inactive';
                        statusText = 'Pois k√§yt√∂st√§';
                        icon = '‚ùå';
                    } else if (!gen.is_available) {
                        statusClass = 'status-rented';
                        statusText = 'Vuokrattu';
                        icon = 'üîí';
                    } else {
                        statusClass = 'status-available';
                        statusText = 'Saatavilla';
                        icon = '‚úÖ';
                    }

                    const card = document.createElement('div');
                    card.className = `generator-card ${statusClass}`;
                    card.innerHTML = `
                        <div>
                            <div class="generator-icon">${icon}</div>
                            <h4>${gen.name}</h4>
                            <p>${statusText}</p>
                        </div>
                        <button class="btn btn--secondary" onclick="toggleGeneratorActive(${gen.id})">
                            ${gen.is_active ? 'Ota pois k√§yt√∂st√§' : 'Ota k√§ytt√∂√∂n'}
                        </button>
                    `;
                    container.appendChild(card);
                });
            } catch (error) {
                console.error('Error loading generator status:', error);
            }
        }
        
        async function loadRentals() {
            try {
                const url = currentFilter === 'all' 
                    ? `${API_BASE}/api/admin/rentals`
                    : `${API_BASE}/api/admin/rentals?status=${currentFilter}`;
                    
                const response = await fetch(url);
                const rentals = await response.json();
                const tbody = document.getElementById('rentalsTableBody');
                tbody.innerHTML = '';
                
                if (rentals.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" style="text-align: center;">Ei varauksia t√§ss√§ kategoriassa.</td></tr>';
                    return;
                }
                
                rentals.forEach(rental => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${rental.id}</td>
                        <td>${rental.name}</td>
                        <td>${rental.email}<br>${rental.phone}</td>
                        <td>${rental.start_date} - ${rental.end_date}</td>
                        <td>${rental.price}‚Ç¨</td>
                        <td><span class="status-badge ${rental.status}">${getStatusText(rental.status)}</span></td>
                        <td class="actions-cell">${getActionButtons(rental)}</td>
                    `;
                    tbody.appendChild(row);
                });
            } catch (error) {
                console.error('Error loading rentals:', error);
            }
        }
        
        function getStatusText(status) {
            const texts = {
                pending: 'Odottaa hyv√§ksynt√§√§',
                approved: 'Hyv√§ksytty',
                invoiced: 'Laskutettu',
                paid: 'Maksettu'
            };
            return texts[status] || status;
        }
        
        function getActionButtons(rental) {
            let buttons = '';
            if (rental.status === 'pending') {
                buttons += `<button class="btn btn--primary action-btn" onclick="approveRental(${rental.id})">Hyv√§ksy</button>`;
            } else if (rental.status === 'approved') {
                buttons += `<button class="btn btn--primary action-btn" onclick="sendInvoice(${rental.id})">L√§het√§ lasku</button>`;
            } else if (rental.status === 'invoiced') {
                buttons += `<button class="btn btn--primary action-btn" onclick="markAsPaid(${rental.id})">Merkitse maksetuksi</button>`;
            } else if (rental.status === 'paid' && rental.generator_id) {
                buttons += `<button class="btn btn--secondary action-btn" onclick="returnGenerator(${rental.generator_id})">Palauta</button>`;
            }
            // Add delete button for all statuses
            buttons += `<button class="btn delete-btn" onclick="deleteRental(${rental.id})">Poista</button>`;
            return buttons;
        }

        async function approveRental(rentalId) {
            if (!confirm('Hyv√§ksy varaus ja l√§het√§ vahvistus asiakkaalle?')) return;
            await fetch(`${API_BASE}/api/rentals/${rentalId}/approve`, { method: 'POST' });
            loadAll();
        }
        
        async function sendInvoice(rentalId) {
            if (!confirm('L√§het√§ lasku asiakkaalle?')) return;
            await fetch(`${API_BASE}/api/rentals/${rentalId}/invoice`, { method: 'POST' });
            loadRentals();
        }
        
        async function markAsPaid(rentalId) {
            if (!confirm('Merkitse varaus maksetuksi? T√§m√§ varaa yhden aggregaatin.')) return;
            const response = await fetch(`${API_BASE}/api/rentals/${rentalId}/paid`, { method: 'POST' });
            if (!response.ok) {
                const error = await response.json();
                alert(`Virhe: ${error.error}`);
            }
            loadAll();
        }
        
        async function returnGenerator(generatorId) {
            if (!confirm('Palauta aggregaatti saataville?')) return;
            await fetch(`${API_BASE}/api/generators/${generatorId}/return`, { method: 'POST' });
            loadAll();
        }

        async function deleteRental(rentalId) {
            if (!confirm('Haluatko varmasti poistaa t√§m√§n varauksen? Toimintoa ei voi perua.')) return;
            await fetch(`${API_BASE}/api/rentals/${rentalId}`, { method: 'DELETE' });
            loadAll();
        }

        async function toggleGeneratorActive(generatorId) {
            const action = event.target.textContent.trim().toLowerCase();
            if (!confirm(`Haluatko varmasti ${action}?`)) return;
            await fetch(`${API_BASE}/api/generators/${generatorId}/toggle-active`, { method: 'POST' });
            loadAll();
        }
        
        function filterRentals(status) {
            currentFilter = status;
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');
            loadRentals();
        }
    </script>
</body>
</html>
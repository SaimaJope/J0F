<!DOCTYPE html>
<html lang="fi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JobFuture Admin - Varausten Hallinta</title>
    <link rel="stylesheet" href="style.css">
    <style>
        /* Admin-specific styles - Minimal additions */
        .admin-header {
            background: var(--color-charcoal);
            color: var(--color-pure-white);
            padding: var(--space-md) 0;
            margin-bottom: var(--space-xl);
        }
        
        .admin-title {
            color: var(--color-pure-white);
        }
        
        .status-tabs {
            display: flex;
            gap: var(--space-md);
            margin-bottom: var(--space-lg);
            border-bottom: 2px solid var(--color-light-gray);
        }
        
        .tab {
            padding: var(--space-sm) var(--space-md);
            background: none;
            border: none;
            font-size: var(--font-base);
            cursor: pointer;
            color: var(--color-medium-gray);
            border-bottom: 2px solid transparent;
            margin-bottom: -2px;
            transition: var(--transition);
        }
        
        .tab.active {
            color: var(--color-jobfuture-teal);
            border-bottom-color: var(--color-jobfuture-teal);
        }
        
        .rentals-table {
            width: 100%;
            border-collapse: collapse;
            background: var(--color-pure-white);
        }
        
        .rentals-table th,
        .rentals-table td {
            padding: var(--space-sm);
            text-align: left;
            border-bottom: 1px solid var(--color-light-gray);
        }
        
        .rentals-table th {
            background: var(--color-off-white);
            font-weight: 600;
        }
        
        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: var(--radius);
            font-size: var(--font-small);
            font-weight: 500;
        }
        
        .status-badge.pending {
            background: #FFF3CD;
            color: #856404;
        }
        
        .status-badge.invoiced {
            background: #CCE5FF;
            color: #004085;
        }
        
        .status-badge.paid {
            background: #D4EDDA;
            color: #155724;
        }
        
        .action-btn {
            padding: var(--space-xs) var(--space-sm);
            font-size: var(--font-small);
        }
        
        .generator-status {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: var(--space-md);
            margin-bottom: var(--space-xl);
        }
        
        .generator-card {
            background: var(--color-off-white);
            padding: var(--space-md);
            border-radius: var(--radius);
            text-align: center;
        }
        
        .generator-card.available {
            border: 2px solid #28a745;
        }
        
        .generator-card.rented {
            border: 2px solid #dc3545;
        }
        
        .generator-icon {
            font-size: 3rem;
            margin-bottom: var(--space-sm);
        }
        
        .refresh-btn {
            float: right;
            margin-bottom: var(--space-md);
        }
    </style>
</head>
<body>
    <!-- Admin Header -->
    <header class="admin-header">
        <div class="container">
            <div class="header-content">
                <h1 class="admin-title">JobFuture Admin</h1>
                <a href="/" class="btn btn--secondary">Takaisin sivustolle</a>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container">
        <!-- Generator Status -->
        <section>
            <h2>Aggregaattien tila</h2>
            <div class="generator-status" id="generatorStatus">
                <!-- Will be populated by JavaScript -->
            </div>
        </section>

        <!-- Rentals Management -->
        <section>
            <h2>Varaukset</h2>
            <button class="btn btn--secondary refresh-btn" onclick="loadRentals()">ðŸ”„ PÃ¤ivitÃ¤</button>
            
            <div class="status-tabs">
                <button class="tab active" onclick="filterRentals('all')">Kaikki</button>
                <button class="tab" onclick="filterRentals('pending')">Odottaa laskutusta</button>
                <button class="tab" onclick="filterRentals('invoiced')">Laskutettu</button>
                <button class="tab" onclick="filterRentals('paid')">Maksettu</button>
            </div>
            
            <table class="rentals-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Nimi</th>
                        <th>SÃ¤hkÃ¶posti</th>
                        <th>Puhelin</th>
                        <th>Alkaa</th>
                        <th>PÃ¤Ã¤ttyy</th>
                        <th>Hinta</th>
                        <th>Tila</th>
                        <th>Toiminnot</th>
                    </tr>
                </thead>
                <tbody id="rentalsTableBody">
                    <!-- Will be populated by JavaScript -->
                </tbody>
            </table>
        </section>
    </main>

    <script>
        // Admin functionality - Clean and purposeful
        const API_BASE = window.location.origin;
        let currentFilter = 'all';
        
        // Load data on page load
        document.addEventListener('DOMContentLoaded', () => {
            loadGeneratorStatus();
            loadRentals();
        });
        
        async function loadGeneratorStatus() {
            try {
                const response = await fetch(`${API_BASE}/api/generators/availability`);
                const data = await response.json();
                
                const container = document.getElementById('generatorStatus');
                container.innerHTML = '';
                
                for (let i = 1; i <= 3; i++) {
                    const isAvailable = i <= data.available;
                    const card = document.createElement('div');
                    card.className = `generator-card ${isAvailable ? 'available' : 'rented'}`;
                    card.innerHTML = `
                        <div class="generator-icon">${isAvailable ? 'âœ…' : 'ðŸ”’'}</div>
                        <h4>Aggregaatti ${i}</h4>
                        <p>${isAvailable ? 'Saatavilla' : 'Vuokrattu'}</p>
                    `;
                    container.appendChild(card);
                }
            } catch (error) {
                console.error('Error loading generator status:', error);
            }
        }
        
        async function loadRentals() {
            try {
                const url = currentFilter === 'all' 
                    ? `${API_BASE}/api/admin/rentals`
                    : `${API_BASE}/api/admin/rentals?status=${currentFilter}`;
                    
                const response = await fetch(url);
                const rentals = await response.json();
                
                const tbody = document.getElementById('rentalsTableBody');
                tbody.innerHTML = '';
                
                if (rentals.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="9" style="text-align: center;">Ei varauksia</td></tr>';
                    return;
                }
                
                rentals.forEach(rental => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${rental.id}</td>
                        <td>${rental.name}</td>
                        <td>${rental.email}</td>
                        <td>${rental.phone}</td>
                        <td>${rental.start_date}</td>
                        <td>${rental.end_date}</td>
                        <td>${rental.price}â‚¬</td>
                        <td><span class="status-badge ${rental.status}">${getStatusText(rental.status)}</span></td>
                        <td>${getActionButtons(rental)}</td>
                    `;
                    tbody.appendChild(row);
                });
            } catch (error) {
                console.error('Error loading rentals:', error);
            }
        }
        
        function getStatusText(status) {
            const texts = {
                pending: 'Odottaa',
                invoiced: 'Laskutettu',
                paid: 'Maksettu'
            };
            return texts[status] || status;
        }
        
        function getActionButtons(rental) {
            if (rental.status === 'pending') {
                return `<button class="btn btn--primary action-btn" onclick="sendInvoice(${rental.id})">LÃ¤hetÃ¤ lasku</button>`;
            } else if (rental.status === 'invoiced') {
                return `<button class="btn btn--primary action-btn" onclick="markAsPaid(${rental.id})">Merkitse maksetuksi</button>`;
            } else if (rental.status === 'paid' && rental.generator_id) {
                return `<button class="btn btn--secondary action-btn" onclick="returnGenerator(${rental.generator_id})">Palauta aggregaatti</button>`;
            }
            return '-';
        }
        
        async function sendInvoice(rentalId) {
            if (!confirm('LÃ¤hetÃ¤ lasku asiakkaalle?')) return;
            
            try {
                const response = await fetch(`${API_BASE}/api/rentals/${rentalId}/invoice`, {
                    method: 'POST'
                });
                
                if (response.ok) {
                    alert('Lasku lÃ¤hetetty!');
                    loadRentals();
                }
            } catch (error) {
                console.error('Error sending invoice:', error);
                alert('Virhe laskun lÃ¤hetyksessÃ¤');
            }
        }
        
        async function markAsPaid(rentalId) {
            if (!confirm('Merkitse varaus maksetuksi?')) return;
            
            try {
                const response = await fetch(`${API_BASE}/api/rentals/${rentalId}/paid`, {
                    method: 'POST'
                });
                
                if (response.ok) {
                    alert('Maksu rekisterÃ¶ity!');
                    loadRentals();
                    loadGeneratorStatus();
                } else {
                    const error = await response.json();
                    alert(error.error || 'Virhe maksun rekisterÃ¶innissÃ¤');
                }
            } catch (error) {
                console.error('Error marking as paid:', error);
                alert('Virhe maksun rekisterÃ¶innissÃ¤');
            }
        }
        
        async function returnGenerator(generatorId) {
            if (!confirm('Palauta aggregaatti saataville?')) return;
            
            try {
                const response = await fetch(`${API_BASE}/api/generators/${generatorId}/return`, {
                    method: 'POST'
                });
                
                if (response.ok) {
                    alert('Aggregaatti palautettu!');
                    loadGeneratorStatus();
                }
            } catch (error) {
                console.error('Error returning generator:', error);
                alert('Virhe palautuksessa');
            }
        }
        
        function filterRentals(status) {
            currentFilter = status;
            
            // Update active tab
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');
            
            loadRentals();
        }
    </script>
</body>
</html>